# Практикум по Angie: Расширенные возможности веб-сервера

Этот документ представляет собой серию практических заданий для освоения уникальных и расширенных возможностей веб-сервера Angie, форка Nginx. Практикум сфокусирован на функциях, которые в Angie доступны "из коробки", отличают его от Nginx Open Source или являются частью платной подписки Nginx Plus.

Предполагается, что вы уже знакомы с базовыми концепциями Nginx. Для изучения основ рекомендуется пройти [практикум по Nginx](./Nginx.md).

## Ваша роль: Инженер-практик

Вы — единственный исполнитель всех технических задач. Ваша цель — самостоятельно найти решения, опираясь на теоретические заметки и официальную документацию.

## Моя роль: Ассистент-ментор

Я не даю прямых ответов или готовых команд. Моя задача — задавать наводящие вопросы и давать подсказки, которые помогут вам прийти к решению.

---

## Проект: Создание современного, автоматизированного и наблюдаемого веб-сервиса

Мы пройдем путь от установки Angie до настройки динамически конфигурируемого, отказоустойчивого и высокопроизводительного сервиса с полной наблюдаемостью.

### Фаза 1: Установка и основы

На этом этапе мы установим Angie и настроим базовый сайт.

#### Задание 1.1: Установка Angie
Ваша первая задача — установить Angie и необходимые модули из официального репозитория.

*   **Цель:** Установить Angie и модуль `angie-module-brotli` на вашу ОС. Убедиться, что сервис запускается, и увидеть в браузере стартовую страницу.

#### Задание 1.2: Базовая конфигурация
Настроим простой сайт, чтобы убедиться в совместимости с синтаксисом Nginx.

*   **Цель:** Создать конфигурацию для сайта `site.angie.local`, который будет отдавать статическую страницу из директории `/var/www/angie`.

---

### Фаза 2: Продвинутая балансировка нагрузки

На этом этапе мы используем расширенные возможности балансировки, встроенные в Angie.

#### Задание 2.1: "Липкие" сессии (Sticky Sessions)
Настроим балансировщик, который будет "привязывать" клиента к одному бэкенд-серверу.

*   **Цель:** Настроить `upstream` с тремя бэкендами и включить режим `sticky cookie`, чтобы запросы от одного клиента всегда уходили на один и тот же сервер.

#### Задание 2.2: Динамические апстримы через DNS
Научим Angie автоматически обновлять список бэкендов на основе DNS-записей.

*   **Цель:** Настроить `upstream`, который будет динамически получать список серверов из SRV-записей DNS. Проверить, что при добавлении новой SRV-записи сервер автоматически появляется в балансировке без перезагрузки Angie.

#### Задание 2.3: Плавное управление бэкендами
Освоим безопасный ввод и вывод серверов из ротации.

*   **Цель:** Настроить `upstream` так, чтобы при добавлении нового сервера он входил в балансировку плавно (`slow_start`), а при плановом обслуживании — корректно выводился из ротации (`drain`), дожидаясь завершения текущих запросов.

---

### Фаза 3: Автоматизация, безопасность и современные протоколы

Используем ключевые возможности Angie для упрощения эксплуатации и усиления защиты.

#### Задание 3.1: Автоматическое получение TLS-сертификатов
Настроим Angie на автоматическое получение и обновление сертификатов Let's Encrypt с помощью встроенного ACME-клиента.

*   **Цель:** Для сайта `site.angie.local` получить SSL-сертификат, используя только директивы `acme` в конфигурации Angie, без использования certbot или других внешних утилит.

#### Задание 3.2: Включение поддержки HTTP/3 (QUIC)
Повысим производительность, включив самый современный транспортный протокол.

*   **Цель:** Для сайта, настроенного на HTTPS, включить поддержку HTTP/3. Убедиться, что сервер отдает заголовок `Alt-Svc` и в инструментах разработчика браузера видно использование протокола H3.

#### Задание 3.3: Аутентификация через подзапрос
Реализуем гибкую схему авторизации, делегируя проверку прав доступа внешнему сервису.

*   **Цель:** Защитить `location /private` с помощью `auth_request`. В качестве авторизующего сервиса использовать второй `location`, который возвращает `200` или `403` в зависимости от наличия определенного заголовка в запросе.

#### Задание 3.4: Взаимная аутентификация (mTLS)
Организуем безопасное межсервисное взаимодействие с помощью клиентских сертификатов.

*   **Цель:** Настроить `location /api` таким образом, чтобы доступ к нему был разрешен только клиентам, предоставившим валидный TLS-сертификат, выданный вашим собственным центром сертификации (CA).

---

### Фаза 4: Проксирование на уровне L4 (TCP)

Выйдем за рамки HTTP и поработаем на транспортном уровне.

#### Задание 4.1: Проксирование TCP-трафика
Настроим Angie для безопасного проксирования подключений к базе данных.

*   **Цель:** С помощью модуля `stream` настроить проксирование TCP-соединений с порта `5432` на сервер базы данных PostgreSQL, используя `ssl_preread` для извлечения SNI и маршрутизации к нужному бэкенду.

---

### Фаза 5: Производительность и кэширование

Оптимизируем скорость ответа и снизим нагрузку на бэкенд.

#### Задание 5.1: Серверное кэширование ответов API
Настроим кэширование на стороне Angie, чтобы мгновенно отдавать повторные запросы.

*   **Цель:** Настроить `proxy_cache` для `location`, проксирующего запросы к API. Ответы должны кэшироваться на 1 минуту. Убедиться, что при недоступности бэкенда Angie отдает устаревший ответ из кэша (`proxy_cache_use_stale`).

---

### Фаза 6: Расширенная наблюдаемость (Observability)

Освоим встроенные инструменты мониторинга Angie и настроим сбор метрик и логов.

#### Задание 6.1: Angie Console Lite и API
Получим доступ к статистике сервера в реальном времени через веб-интерфейс и API.

*   **Цель:** Настроить `location` для Angie API и развернуть `angie-console-lite`. Изучить в веб-интерфейсе метрики по HTTP-запросам, апстримам и **статистику кэша (попадания, промахи)**.

#### Задание 6.2: Интеграция с Prometheus и структурированное логирование
Настроим экспорт метрик и логов для системы долгосрочного мониторинга.

*   **Цель:** Настроить в Angie эндпоинт `/p8s` (`prometheus`) для отдачи метрик в формате Prometheus. Одновременно настроить `access_log` в формате **JSON** для последующей отправки в систему сбора логов (например, Loki/ELK). Визуализировать RPS и количество 5xx ошибок в Grafana.

---

### Фаза 7: Построение отказоустойчивого кластера

В качестве итогового проекта объединим полученные знания для создания высокодоступного сервиса.

#### Задание 7.1: HA-кластер с Keepalived
Развернем два сервера Angie, работающих в режиме active/backup.

*   **Цель:** Настроить два узла с Angie и Keepalived, использующих один виртуальный IP (VIP). Реализовать скрипт проверки состояния Angie (`health check`). Протестировать автоматическое переключение (failover) при остановке сервиса Angie на основном узле.