# Практикум по Angie

#### Задание 2.1: "Липкие" сессии (Sticky Sessions)
Настроим балансировщик, который будет "привязывать" клиента к одному бэкенд-серверу.

*   **Цель:** Настроить `upstream` с тремя бэкендами и включить режим `sticky cookie`, чтобы запросы от одного клиента всегда уходили на один и тот же сервер.

#### Задание 2.2: Динамические апстримы через DNS
Научим Angie автоматически обновлять список бэкендов на основе DNS-записей.

*   **Цель:** Настроить `upstream`, который будет динамически получать список серверов из SRV-записей DNS. Проверить, что при добавлении новой SRV-записи сервер автоматически появляется в балансировке без перезагрузки Angie.

#### Задание 2.3: Плавное управление бэкендами
Освоим безопасный ввод и вывод серверов из ротации.

*   **Цель:** Настроить `upstream` так, чтобы при добавлении нового сервера он входил в балансировку плавно (`slow_start`), а при плановом обслуживании — корректно выводился из ротации (`drain`), дожидаясь завершения текущих запросов.

---

### Фаза 3: Автоматизация, безопасность и современные протоколы

#### Задание 3.2: Включение поддержки HTTP/3 (QUIC)
Повысим производительность, включив самый современный транспортный протокол.

*   **Цель:** Для сайта, настроенного на HTTPS, включить поддержку HTTP/3. Убедиться, что сервер отдает заголовок `Alt-Svc` и в инструментах разработчика браузера видно использование протокола H3.


---

### Фаза 4: Проксирование на уровне L4 (TCP)

Выйдем за рамки HTTP и поработаем на транспортном уровне.

#### Задание 4.1: Проксирование TCP-трафика
Настроим Angie для безопасного проксирования подключений к базе данных.

*   **Цель:** С помощью модуля `stream` настроить проксирование TCP-соединений с порта `5432` на сервер базы данных PostgreSQL, используя `ssl_preread` для извлечения SNI и маршрутизации к нужному бэкенду.

### Фаза 6: Расширенная наблюдаемость (Observability)

Освоим встроенные инструменты мониторинга Angie и настроим сбор метрик и логов.

#### Задание 6.1: Angie Console Lite и API
Получим доступ к статистике сервера в реальном времени через веб-интерфейс и API.

*   **Цель:** Настроить `location` для Angie API и развернуть `angie-console-lite`. Изучить в веб-интерфейсе метрики по HTTP-запросам, апстримам и **статистику кэша (попадания, промахи)**.

#### Задание 6.2: Интеграция с Prometheus и структурированное логирование
Настроим экспорт метрик и логов для системы долгосрочного мониторинга.

*   **Цель:** Настроить в Angie эндпоинт `/p8s` (`prometheus`) для отдачи метрик в формате Prometheus. Одновременно настроить `access_log` в формате **JSON** для последующей отправки в систему сбора логов (например, Loki/ELK). Визуализировать RPS и количество 5xx ошибок в Grafana.

---

### Фаза 7: Построение отказоустойчивого кластера

В качестве итогового проекта объединим полученные знания для создания высокодоступного сервиса.

#### Задание 7.1: HA-кластер с Keepalived
Развернем два сервера Angie, работающих в режиме active/backup.

*   **Цель:** Настроить два узла с Angie и Keepalived, использующих один виртуальный IP (VIP). Реализовать скрипт проверки состояния Angie (`health check`). Протестировать автоматическое переключение (failover) при остановке сервиса Angie на основном узле.
