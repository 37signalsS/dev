# Практикум по Nginx: от основ до Production

Этот документ содержит серию практических заданий, разработанных для освоения всего теоретического материала из директории `notes/WebServers/Nginx`. Вы выступите в роли DevOps-инженера, которому предстоит развернуть, защитить и оптимизировать веб-сервис с нуля.

## Ваша роль: Инженер-практик

Вы — единственный исполнитель всех технических задач. Ваша цель — самостоятельно найти решения, опираясь на теоретические заметки и официальную документацию.

## Моя роль: Ассистент-ментор

Я не даю прямых ответов, готовых команд или фрагментов конфигурации. Моя задача — задавать наводящие вопросы и давать подсказки, которые помогут вам прийти к решению.

---

## Проект: Создание отказоустойчивого и высокопроизводительного веб-сервиса

Мы пройдем путь от установки Nginx до настройки сложного, готового к реальным нагрузкам веб-сервиса.

### Фаза 1: Основы — хостинг статического сайта

На этом этапе мы развернем простой статический сайт и освоим базовые директивы Nginx.

#### Задание 1.1: Установка и базовый запуск
Ваша первая задача — установить Nginx и запустить простейший сайт.

*   **Цель:** Увидеть в браузере страницу, отдаваемую вашим Nginx.
*   **Наводящие вопросы:**
    *   Как установить Nginx с помощью пакетного менеджера вашей ОС?
    *   Как проверить, что служба Nginx запущена и работает? Какие команды `systemctl` для этого используются?
    *   Где Nginx по умолчанию хранит файлы конфигурации и веб-страницы?
    *   Создайте простой HTML-файл. Как сделать так, чтобы Nginx отдавал его по-умолчанию?

#### Задание 1.2: Виртуальные хосты
Теперь усложним задачу: ваш сервер должен обслуживать два разных сайта.

*   **Цель:** При обращении к `site1.local` и `site2.local` должны открываться разные страницы.
*   **Наводящие вопросы:**
    *   Что такое "виртуальный хост" или `server block` в терминах Nginx?
    *   Какая директива отвечает за привязку конфигурации к доменному имени?
    *   Как организовать файлы конфигурации для нескольких сайтов? В чем разница между подходами в Debian-подобных системах (`sites-available`/`sites-enabled`) и CentOS/RHEL (`conf.d`)?
    *   Как сообщить вашей локальной машине, что домены `site1.local` и `site2.local` указывают на ваш собственный IP-адрес? (Подсказка: файл `/etc/hosts`)

#### Задание 1.3: Маршрутизация с `location`
Научимся управлять обработкой запросов в зависимости от URI.

*   **Цель:** Запросы к `http://site1.local/images/...` должны отдавать файлы из отдельной директории, а `http://site1.local/assets/...` — из другой.
*   **Наводящие вопросы:**
    *   Как работает директива `location`?
    *   Какой синтаксис используется для совпадения по префиксу URI?
    *   Как указать корневую директорию для файлов внутри specific `location`?

#### Задание 1.4: "Красивые" URL и обработка ошибок
Сделаем сайт более дружелюбным к пользователю.

*   **Цель:** Запрос к `/about` должен открывать страницу `/about.html` без изменения URL в браузере. При запросе несуществующей страницы должна отображаться ваша кастомная страница ошибки 404.
*   **Наводящие вопросы:**
    *   Какая директива позволяет проверить существование файлов в определенном порядке?
    *   Как с помощью этой директивы реализовать отдачу `page.html` по запросу `/page`?
    *   Как настроить Nginx на отдачу специальной страницы при ошибке 404?

---

### Фаза 2: Динамические приложения — реверс-прокси и балансировка

На этом этапе мы подключим к нашему Nginx бэкенд-приложение.

#### Задание 2.1: Реверс-прокси
Настроим Nginx в роли посредника между клиентом и вашим веб-приложением.

*   **Цель:** Запросы к `http://api.site1.local` должны перенаправляться на простое приложение, запущенное, например, на порту 8000.
*   **Наводящие вопросы:**
    *   Напишите простейшее веб-приложение на любом знакомом вам языке (Python/Flask, Node.js/Express), которое будет отвечать "Hello from backend!".
    *   Какая директива в Nginx используется для перенаправления запросов на другой сервер (бэкенд)?
    *   Какие HTTP-заголовки важно передавать бэкенду, чтобы он знал реальный IP-адрес клиента и исходный хост?

#### Задание 2.2: Балансировка нагрузки
Сделаем нашу систему отказоустойчивой, запустив несколько копий бэкенда.

*   **Цель:** Nginx должен распределять запросы между тремя экземплярами вашего приложения, запущенными на разных портах.
*   **Наводящие вопросы:**
    *   Как в Nginx объявить группу бэкенд-серверов?
    *   Как изменить конфигурацию `proxy_pass`, чтобы она указывала на эту группу?
    *   Попробуйте разные алгоритмы балансировки. Как заставить Nginx отправлять запросы на наименее загруженный сервер? А как "прилепить" клиента к одному и тому же бэкенду (sticky session)?

#### Задание 2.3: Проксирование L4 (TCP)
Выйдем за рамки HTTP и поработаем на транспортном уровне.

*   **Цель:** Настроить Nginx для проксирования TCP-соединений к базе данных (например, PostgreSQL или MariaDB).
*   **Наводящие вопросы:**
    *   Какой модуль и какой основной блок конфигурации (`stream` или `http`) используется для работы с TCP/UDP трафиком?
    *   Как синтаксис `server` и `upstream` в этом контексте отличается от HTTP?
    *   Как настроить Nginx, чтобы он слушал один порт, а перенаправлял соединения на другой порт, где работает ваша база данных?

---

### Фаза 3: Безопасность

Защитим наш сервис от угроз.

#### Задание 3.1: Шифрование (TLS/SSL)
Весь трафик должен быть зашифрован.

*   **Цель:** Сайт `site1.local` должен работать по HTTPS. Все HTTP-запросы должны автоматически перенаправляться на HTTPS.
*   **Наводящие вопросы:**
    *   Как сгенерировать самоподписанный SSL-сертификат для тестирования?
    *   Какие директивы Nginx отвечают за подключение сертификата и приватного ключа?
    *   Как изменить `listen`, чтобы включить SSL?
    *   Какой код ответа и какую директиву лучше использовать для перенаправления с HTTP на HTTPS?

#### Задание 3.2: Усиление TLS
Добьемся оценки A+ на SSL Labs.

*   **Цель:** Настроить TLS так, чтобы поддерживались только современные, безопасные протоколы и шифры.
*   **Наводящие вопросы:**
    *   Какие версии TLS считаются устаревшими и должны быть отключены?
    *   Что такое Forward Secrecy и как его обеспечивает правильный набор шифров?
    *   Что такое HSTS и как этот заголовок защищает от атак "человек-посередине"?
    *   Что такое OCSP Stapling и как он ускоряет первоначальное TLS-соединение?

#### Задание 3.3: Ограничение доступа
Создадим приватную зону, доступную не для всех.

*   **Цель:** Создать `location /admin`, доступ к которому будет только с вашего IP-адреса. Затем добавить парольную защиту.
*   **Наводящие вопросы:**
    *   Какие директивы используются для разрешения и запрета доступа по IP? Важен ли их порядок?
    *   Что такое `auth_basic`? Как создать файл с паролями для этой директивы?
    *   Почему `auth_basic` обязательно нужно использовать только вместе с HTTPS?

#### Задание 3.4: Взаимная аутентификация (mTLS)
Реализуем самый строгий способ аутентификации.

*   **Цель:** Настроить `location /private_api` так, чтобы доступ к нему был возможен только при предоставлении валидного клиентского SSL-сертификата.
*   **Наводящие вопросы:**
    *   Вам понадобится собственный Центр Сертификации (CA). Как его создать с помощью OpenSSL?
    *   Как выпустить серверный и клиентский сертификаты, подписанные вашим CA?
    *   Какие директивы в Nginx включают проверку клиентского сертификата и указывают на доверенный CA?
    *   Как с помощью `curl` проверить, что доступ с клиентским сертификатом работает, а без него — нет?

---

### Фаза 4: Оптимизация производительности

Выжмем максимум из нашего сервера.

#### Задание 4.1: Кэширование
Ускорим доставку контента и снизим нагрузку на бэкенд.

*   **Цель:** Настроить два типа кэширования: для статики (CSS, JS) в браузере клиента, и для ответов API на стороне Nginx.
*   **Наводящие вопросы:**
    *   **Клиентское кэширование:** Какие HTTP-заголовки (`Expires`, `Cache-Control`) заставляют браузер хранить файлы локально? Как настроить Nginx, чтобы он добавлял их для статических файлов?
    *   **Серверное кэширование:** Как настроить `proxy_cache`? Какие директивы определяют путь хранения кэша, его размер и время жизни кэшированных ответов?
    *   Как с помощью HTTP-заголовка (`X-Proxy-Cache`) проверить, был ли ответ взят из кэша (`HIT`) или получен от бэкенда (`MISS`)?

#### Задание 4.2: Сжатие
Уменьшим объем передаваемых данных.

*   **Цель:** Включить сжатие для текстовых данных (HTML, CSS, JS). Использовать как динамическое, так и статическое сжатие.
*   **Наводящие вопросы:**
    *   Какие директивы включают динамическое сжатие `gzip`?
    *   Что такое статическое сжатие? Как подготовить `.gz` и `.br` (Brotli) версии ваших файлов?
    *   Как настроить Nginx, чтобы он автоматически отдавал предварительно сжатые файлы, если они существуют и поддерживаются браузером?

#### Задание 4.3: Современные протоколы и форматы
Идем в ногу со временем.

*   **Цель:** Включить поддержку протоколов HTTP/2 и HTTP/3. Настроить Nginx так, чтобы он отдавал изображения в формате WebP или AVIF, если браузер их поддерживает.
*   **Наводящие вопросы:**
    *   Как включить поддержку HTTP/2 и HTTP/3 в директиве `listen`? Какие еще директивы и заголовки для этого нужны?
    *   **Адаптивные изображения:** Как с помощью директивы `map` и переменной `$http_accept` создать новую переменную, указывающую на нужный формат (`.webp`)?
    *   Как затем использовать эту переменную в `try_files`, чтобы сначала попытаться отдать WebP-версию, и только потом — оригинальный JPEG/PNG?

#### Задание 4.4: Тонкая настройка Nginx
Поработаем с "сердцем" Nginx.

*   **Цель:** Оптимизировать использование процессорных ядер и сетевого стека.
*   **Наводящие вопросы:**
    *   За что отвечают директивы `worker_processes` и `worker_connections`? Какое значение для `worker_processes` обычно является оптимальным?
    *   Что такое `sendfile` и `tcp_nopush`? Как они ускоряют отдачу статики?
    *   Что дает опция `reuseport` в директиве `listen` на многоядерных системах?

---

### Фаза 5: Эксплуатация и мониторинг

Научимся поддерживать наш сервис в рабочем состоянии.

#### Задание 5.1: Поиск неисправностей
Лучший способ научиться чинить — это ломать.

*   **Цель:** Научиться быстро диагностировать и устранять самые частые проблемы.
*   **Практика:**
    1.  Допустите синтаксическую ошибку в конфигурации. Как `nginx -t` помогает ее найти?
    2.  Укажите неверный путь к файлам сайта. Какую ошибку вы увидите в браузере и в `error.log`?
    3.  Установите на файлы сайта права, запрещающие чтение для пользователя, от имени которого работает Nginx (обычно `www-data`). Что произойдет?
    4.  Остановите бэкенд-приложение. Какую ошибку вернет Nginx?

#### Задание 5.2: Мониторинг
Нельзя управлять тем, что нельзя измерить.

*   **Цель:** Собрать и визуализировать метрики производительности Nginx.
*   **Наводящие вопросы:**
    *   Что такое модуль `nginx-module-vts`? Как скомпилировать Nginx с ним? (Это сложное, но очень полезное упражнение).
    *   Как настроить `location`, чтобы он отдавал метрики в формате, совместимом с Prometheus?
    *   Как настроить Prometheus для сбора (scrape) этих метрик?
    *   Как найти и импортировать в Grafana готовый дашборд для визуализации метрик Nginx VTS?
